services:
  movies-api:
    build:
      context: ./server/movies
      dockerfile: Dockerfile
    image: movies-api:latest
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_POSTGRES_URL: "jdbc:postgresql://aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres?sslmode=require&options=project%3Dqvmwyjeijozwdvynyixx"
      SPRING_DATASOURCE_POSTGRES_USERNAME: "postgres.qvmwyjeijozwdvynyixx"
      SPRING_DATASOURCE_POSTGRES_PASSWORD: "SkAeht@Users@369$"
      SPRING_DATA_MONGODB_URI: "mongodb+srv://TheAKS:MovieAPI_2025@movieapi.kzzatu0.mongodb.net"
      SPRING_DATA_MONGODB_DATABASE: "movie-api-db"
      CORS_ORIGINS: "http://localhost:3000"
      SPRING_FLYWAY_ENABLED: "true"
      SPRING_FLYWAY_BASELINE_ON_MIGRATE: "true"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 5s
      start_period: 30s
      retries: 3

  movie-review-frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        # injected at build time into Vite (optional; remove if not needed)
        VITE_API_BASE_URL: "http://localhost:8080/api/v1"
    image: movie-review-frontend:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    depends_on:
      movies-api:
        condition: service_healthy
    healthcheck:
      # 'serve' returns index.html at '/', so root works for HC
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
